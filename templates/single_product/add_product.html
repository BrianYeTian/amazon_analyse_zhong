<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    {#    网站图形标需要修改#}
    <link rel="icon" href="https://cdn.jsdelivr.net/npm/@bootcss/v3.bootcss.com@1.0.13/favicon.ico">
    <link rel="canonical" href="https://getbootstrap.com/docs/3.4/examples/dashboard/">

    <title>添加产品</title>
    <!-- <link rel="stylesheet" href="/static/js/jquery-1.8.3.min.js"> -->
    <!-- Bootstrap core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@bootcss/v3.bootcss.com@1.0.13/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="https://cdn.jsdelivr.net/npm/@bootcss/v3.bootcss.com@1.0.13/assets/css/ie10-viewport-bug-workaround.css"
          rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="https://cdn.jsdelivr.net/npm/@bootcss/v3.bootcss.com@1.0.13/examples/dashboard/dashboard.css"
          rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/npm/@bootcss/v3.bootcss.com@1.0.13/assets/js/ie8-responsive-file-warning.js"></script>
    <![endif]-->
    <script src="https://cdn.jsdelivr.net/npm/@bootcss/v3.bootcss.com@1.0.13/assets/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="shortcut icon" href="/static/ico/favicon.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/static/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/static/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/static/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/static/ico/apple-touch-icon-57-precomposed.png">
</head>
<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                        aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="{{ url_for('user_bp.index') }}">亚马逊数据分析平台</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li style="margin-top: 14px; color: #8a6d3b">欢迎
                        <mark style="background-color: #222222;color: #8a6d3b">{{ user.username }}</mark>
                    </li>
                    <li><a href="{{ url_for('user_bp.logout') }}">退出</a></li>
                </ul>
                {#            搜索结果要往哪里提交？#}
                <form class="navbar-form navbar-right">
                    <input type="text" class="form-control" placeholder="搜索...">
                </form>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
    <div class="row">
        <div class="col-sm-3 col-md-2 sidebar">
            <ul class="nav nav-sidebar">
                <li><a href="{{ url_for('user_bp.index') }}">概 述 <span
                        class="sr-only">(current)</span></a></li>
                <li><a href="#">广告分析</a></li>
                <li><a href="#">关键词查询</a></li>
                <li><a href="{{ url_for('cate_bp.get_cate') }}">亚马逊目录</a></li>
            </ul>
            <ul class="nav nav-sidebar">
                <li class="active"><a href="{{ url_for('sp_bp.dp') }}">亚马逊单品数据获取</a></li>
                <li><a href="{{ url_for('sp_bp.get_review') }}">亚马逊单品评价获取</a></li>
                <li><a href="{{ url_for('sr_bp.add_search') }}">亚马逊关键词搜索获取</a></li>
            </ul>
        </div>
    </div>

{#    <div class="container">#}
        <div class="row">
            <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
                <h1 style="color: black; text-align: center" class="page-header">添加商品链接</h1>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-4 col-sm-offset-5 form-box" style="margin-top: 5%">
                <p style="color: black; margin-top: 2%">
                        这是一个亚马逊商品监控系统<a href="https://www.amazon.com/"><strong>Amazon</strong></a>
                </p>
                <div class="form-top" style="margin-top: 10%">
                    <div class="form-top-left">
                        <p>请输入正确的商品链接,无效链接将不会被抓取 <br>
                            <span style="color: lightblue">支持直接从亚马逊前台页面复制粘贴产品链接</span></p>
                    </div>
                    <div class="form-top-right">
                        <i class="fa fa-key"></i>
                    </div>
                </div>

                <div class="form-bottom" style="margin-top: 5%">
                    <form method="post" role="form" action="{{url_for('sp_bp.add')}}" id="form1" class="login-form">
                        <div class="form-group">
                            <label class="sr-only" for="shopurl">商品链接</label>
                            <input type="text" name="shopurl" placeholder="商品链接..." class="form-username form-control" id="shopurl" >
{#                            <input type="checkbox" name="spider_time" id="chekck1" value="0"><label>长期监控</label>#}
{#                            <input type="checkbox" name="spider_time" id="chekck2" value="1"><label>短期监控</label>#}
                        </div>
                        <button type="submit" class="btn btn-success btn-block" id="putdata">提交</button>
                    </form>
                    <br>

                    <label for="exampleInputFile">批量上传</label>
                    <input type="file" accept=".xls,.xlsx,.csv" id="exampleInputFile" onchange="readExcel()">
                    <p class="help-block">Example block-level help text here.</p>
                    <p></p>
                    <div id="result"></div>

                </div>

            </div>
        </div>

    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="/static/js/xlsx.core.min.js"></script>

    {% if add_msg %}
        <div class="hidden" id="msg" name="msg">{{add_msg[0].msg}}</div>
        <script language="javascript" >
            window.onload = function(){
                        var obj = document.getElementById("msg").innerHTML;
                        $(function fun(){
                            alert(obj);
                        })
                    }

        </script>
    {% endif %}


    <script>
        function readExcel() {
            var file = document.getElementById('exampleInputFile').files[0];
            if (file) {
                  var reader = new FileReader();

                  reader.onload = function (e) {
                    var data = e.target.result;
                    var workbook = XLSX.read(data, { //XLSX.read()方法会返回一个workbook 对象
                      type: 'binary'
                    });
                    readWorkbook(workbook);
                  };
                  reader.readAsBinaryString(file);

                } else {
                  alert('请先选择文件');
            }
        }

        var json = null;
        var csv = '';

        function readWorkbook(workbook) {

           var sheetNames = workbook.SheetNames; // 工作表名称集合
           var worksheet = workbook.Sheets[sheetNames[0]]; // 这里我们只读取第一张sheet的内容

           csv = XLSX.utils.sheet_to_csv(worksheet); //这里便可以得到csv格式
           document.getElementById('result').innerHTML = csv2table(csv);  //使用csv2table()函数将其转换为简单的HTML表格，csv2table()函数定义在下一个代码块中

           json = XLSX.utils.sheet_to_json(worksheet);

            var idArray = new Array();
           for (var i = 0;i<json.length;i++){
               idArray.push(json[i])
           }

           console.log(json)

            topy(idArray)

       }


        function csv2table(csv) {
             var html = '<table>';
             var rows = csv.split('\n');
             rows.pop(); // 最后一行没用的
             rows.forEach(function (row, idx) {
               var columns = row.split(',');
               columns.unshift(idx + 1); // 添加行索引
               if (idx == 0) { // 添加列索引
                 html += '<tr>';
                 for (var i = 0; i < columns.length; i++) {
                   html += '<th>' + (i == 0 ? '' : String.fromCharCode(65 + i - 1)) + '</th>';
                 }
                 html += '</tr>';
               }
               html += '<tr>';
               columns.forEach(function (column) {
                 html += '<td>' + column + '</td>';
               });
               html += '</tr>';
             });
             html += '</table>';
             return html;
        }

        function topy(idArray) {
            //alert(idArray)
            $.ajax({
                    url:'{{ url_for('sp_bp.add_by_sheet') }}',
                    type: 'post',
                    dataType:'json',
                    data:{'data':JSON.stringify(idArray)},
                    success:function (msg) {
                        alert(msg)
                    }
                })

        }

    </script>

</body>
</html>